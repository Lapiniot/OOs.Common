<Project>
  <Import Project="PublishAll.targets" />

  <PropertyGroup>
    <TargetLatestRuntimePatch>true</TargetLatestRuntimePatch>
  </PropertyGroup>

  <Target Name="ConfigurePublishContainer">
    <PropertyGroup>
      <PublishProfile Condition=" '$(PublishProfile)' == '' OR '$(PublishProfile)' == 'Default' ">DefaultContainer</PublishProfile>
      <PublishProperties>PublishProfile=$(PublishProfile)</PublishProperties>
    </PropertyGroup>
  </Target>

  <Target Name="_PublishMultiArchImage" Condition=" '$(ContainerRepository)' != '' ">
    <PropertyGroup>
      <ContainerManifest>$(ContainerRepository):latest</ContainerManifest>
    </PropertyGroup>
    <Exec Command="docker manifest rm $(ContainerManifest)" ConsoleToMsBuild="true" IgnoreExitCode="true" />
    <Exec Command="docker manifest create $(ContainerManifest) @(RuntimeIdentifiersToPublish->'--amend $(ContainerRepository):%(Identity)', ' ')" />
    <Exec Command="docker manifest push $(ContainerManifest)" />
  </Target>

  <Target Name="PublishAllImages" DependsOnTargets="ConfigurePublishContainer;PublishAll">
    <CallTarget Targets="_PublishMultiArchImage" />
  </Target>

</Project>