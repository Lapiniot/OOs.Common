<Project>
  <Import Project="PublishAll.targets" />

  <PropertyGroup>
    <TargetLatestRuntimePatch>true</TargetLatestRuntimePatch>
    <RuntimeIdentifiers>linux-x64;linux-arm64</RuntimeIdentifiers>
  </PropertyGroup>

  <ItemGroup>
    <PublishProperty Include="Configuration" Default="Release" />
    <PublishProperty Include="PublishProfile" Default="DefaultContainer" />
    <PublishProperty Include="SelfContained" Default="true" />
    <PublishProperty Include="PublishTrimmed" Default="true" />
    <PublishProperty Include="SuppressTrimAnalysisWarnings" Default="true" />
  </ItemGroup>

  <!-- Capture initial values of related properties into local private props -->
  <!-- Try to set properties value to some dummy string -->
  <!-- Only local properties will be affected -->
  <!-- Global properties will stay intact (overriden from command-line) -->
  <!-- Set flag property to indicate whether specific property is global -->
  <!-- Restore initial values-->
  <PropertyGroup>
    <__Configuration>$(Configuration)</__Configuration>
    <Configuration>__dummy</Configuration>
    <__ConfigurationGlobal Condition=" '$(Configuration)' == '$(__Configuration)' ">true</__ConfigurationGlobal>
    <Configuration>$(__Configuration)</Configuration>

    <__PublishProfile>$(PublishProfile)</__PublishProfile>
    <PublishProfile>__dummy</PublishProfile>
    <__PublishProfileGlobal Condition=" '$(PublishProfile)' == '$(__PublishProfile)' ">true</__PublishProfileGlobal>
    <PublishProfile>$(__PublishProfile)</PublishProfile>

    <__SelfContained>$(SelfContained)</__SelfContained>
    <SelfContained>__dummy</SelfContained>
    <__SelfContainedGlobal Condition=" '$(SelfContained)' == '$(__SelfContained)' ">true</__SelfContainedGlobal>
    <SelfContained>$(__SelfContained)</SelfContained>

    <__PublishTrimmed>$(PublishTrimmed)</__PublishTrimmed>
    <PublishTrimmed>__dummy</PublishTrimmed>
    <__PublishTrimmedGlobal Condition=" '$(PublishTrimmed)' == '$(__PublishTrimmed)' ">true</__PublishTrimmedGlobal>
    <PublishTrimmed>$(__PublishTrimmed)</PublishTrimmed>

    <__SuppressTrimAnalysisWarnings>$(SuppressTrimAnalysisWarnings)</__SuppressTrimAnalysisWarnings>
    <SuppressTrimAnalysisWarnings>__dummy</SuppressTrimAnalysisWarnings>
    <__SuppressTrimAnalysisWarningsGlobal Condition=" '$(SuppressTrimAnalysisWarnings)' == '$(__SuppressTrimAnalysisWarnings)' ">true</__SuppressTrimAnalysisWarningsGlobal>
    <SuppressTrimAnalysisWarnings>$(__SuppressTrimAnalysisWarnings)</SuppressTrimAnalysisWarnings>
  </PropertyGroup>

  <Target Name="ConfigurePublishContainer">
    <ItemGroup>
      <PublishPropertyOverride Include="@(PublishProperty)" Condition=" '$(__%(Identity)Global)' != 'true' " />
    </ItemGroup>
    <PropertyGroup>
      <PublishProperties>@(PublishPropertyOverride->'%(Identity)=%(Default)')</PublishProperties>
    </PropertyGroup>
  </Target>

  <Target Name="_PublishMultiArchImage" Condition=" '$(ContainerRepository)' != '' ">
    <PropertyGroup>
      <ContainerManifest>$(ContainerRepository):latest</ContainerManifest>
    </PropertyGroup>
    <Exec Command="docker manifest rm $(ContainerManifest)" ConsoleToMsBuild="true" IgnoreExitCode="true" />
    <Exec Command="docker manifest create $(ContainerManifest) @(RuntimeIdentifiersToPublish->'--amend $(ContainerRepository):%(Identity)', ' ')" />
    <Exec Command="docker manifest push $(ContainerManifest)" />
  </Target>

  <Target Name="PublishAllImages" DependsOnTargets="ConfigurePublishContainer;PublishAll">
    <CallTarget Targets="_PublishMultiArchImage" />
  </Target>

</Project>