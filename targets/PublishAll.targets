<Project>

  <Target Name="PublishAllRIDs">
    <Error Condition=" $(RuntimeIdentifiers) == '' "
      Text="This target is only applicable for builds with a multiple RIDs specified via RuntimeIdentifiers property." />

    <PropertyGroup>
      <PublishAllRIDsTargets Condition=" $(PublishAllRIDsTargets) == '' ">Publish</PublishAllRIDsTargets>
    </PropertyGroup>

    <ItemGroup>
      <_RuntimeIdentifiersToPublish Include="$(RuntimeIdentifiers)" />
      <_ProjectsToPublish Include="@(_RuntimeIdentifiersToPublish->'$(MSBuildProjectFullPath)')">
        <AdditionalProperties>
          RuntimeIdentifiers=;
          RuntimeIdentifier=%(_RuntimeIdentifiersToPublish.Identity)
        </AdditionalProperties>
      </_ProjectsToPublish>
    </ItemGroup>

    <MSBuild Projects="@(_ProjectsToPublish)"
      Targets="$(PublishAllRIDsTargets)"
      Properties="$(PublishAllRIDsProperties)"
      RemoveProperties="RuntimeIdentifiers"
      BuildInParallel="$([MsBuild]::ValueOrDefault('$(PublishAllRIDsBuildInParallel)', 'True'))">
      <Output TaskParameter="TargetOutputs"
        ItemName="$([MSBuild]::ValueOrDefault('$(PublishAllRIDsTargetOutputItemName)', 'PublishAllRIDsOutput'))" />
    </MSBuild>
  </Target>

</Project>